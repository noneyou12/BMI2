<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container">
      <div class="d-flex align-items-baseline">
        <button class="back-arrow btn fs-1" onclick="window.history.back();">
          &#8592;
        </button>
        <h2>Calculation History</h2>
      </div>

      <table
        id="history-table"
        class="table table-bordered border-success border border-3"
      >
        <thead>
          <tr>
            <th>Date Time</th>
            <th>Age</th>
            <th>BMI</th>
            <th>Height</th>
            <th>Weight</th>
            <th>Gender</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody id="history-table-body"></tbody>
      </table>
    </div>
  </body>
  <script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    loadHistory();
    async function loadHistory() {
      const tableBody = document.getElementById("history-table-body");
      if (!tableBody) return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö Body ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á

      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
      tableBody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

      try {
        const response = await fetch("http://localhost:5000/api/history");

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const historyData = await response.json();

        // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading
        tableBody.innerHTML = "";

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (historyData.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7">No calculation history found.</td></tr>';
          return;
        }

        // Render ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        historyData.forEach((entry) => {
          const row = tableBody.insertRow();

          // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤ date ‡πÄ‡∏õ‡πá‡∏ô ISO string)
          const dateObj = new Date(entry.date);
          const dateStr = dateObj
            .toLocaleDateString("th-TH", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            })
            .replace(/\//g, "-");
          const timeStr = dateObj.toLocaleTimeString("th-TH", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
          const dateTime = `${dateStr} ${timeStr}`;

          // ‡πÄ‡∏û‡∏¥‡πà‡∏° Cell ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Column ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
          row.insertCell().textContent = dateTime;
          row.insertCell().textContent = entry.age;
          row.insertCell().textContent = entry.BMI; // ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ BMI ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß
          row.insertCell().textContent = entry.height;
          row.insertCell().textContent = entry.weight;
          row.insertCell().textContent =
            entry.gender.charAt(0).toUpperCase() + entry.gender.slice(1); // Male/Female
          row.insertCell().textContent = entry.result; // Catelogy ‡πÄ‡∏ä‡πà‡∏ô 'Average'
        });
      } catch (error) {
        console.error("Error loading BMI history:", error);
        tableBody.innerHTML =
          '<tr><td colspan="7">Error loading data. Check server connection.</td></tr>';
      }
    }

    // üí° ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ History
    // window.addEventListener('load', loadHistory); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° 'View History'
  </script>
</html>
